<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de ULFs — Lite</title>
  <meta name="description" content="Calculadora de ULFs - Versão Lite (sem Valor R$)." />
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --muted:#aab2c0; --text:#e8ecf1;
      --primary:#2bb673; --accent:#3ea1ff; --danger:#e53935; --border:#252a34;
      --table-strip:#11141a; --warning:#ff7a1a; --input-bg:#0c0f14;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:#8ec7ff}
    .wrap{max-width:1100px;margin:0 auto;padding:24px 16px}
    h1{margin:0 0 8px;font-size:24px}
    p.lead{margin:0 0 16px;color:var(--muted);font-size:14px}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin-top:12px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .col-12{grid-column:span 12}
    .col-8{grid-column:span 8}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    @media (max-width:960px){.col-md-6{grid-column:span 6}}
    @media (max-width:720px){.col-12,.col-8,.col-6,.col-4,.col-3,.col-md-6{grid-column:1/-1}}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    select,input{
      width:100%; padding:12px 12px; border-radius:8px; border:1px solid var(--border);
      background:var(--input-bg); color:var(--text); outline:none; height:44px;
    }
    select:focus,input:focus{border-color:var(--accent)}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#11161f;color:var(--text);
      padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;height:40px}
    .btn-primary{background:var(--primary);border-color:var(--primary);color:#06140c}
    .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
    .btn-warning{background:var(--warning);border-color:var(--warning);color:#1c120a}
    .small{font-size:12px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
    thead th{text-align:left;font-weight:700;color:var(--muted);border-bottom:1px solid var(--border);padding:10px 8px}
    tbody td{padding:10px 8px;border-bottom:1px solid var(--border)}
    tbody tr:nth-child(odd){background:var(--table-strip)}
    tfoot td{padding:12px 8px;font-weight:700}
    .right{text-align:right}
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    .kpi .box{background:#0c0f14;border:1px solid var(--border);border-radius:10px;padding:12px}
    .kpi .box h3{margin:0 0 4px;font-size:13px;color:var(--muted)}
    .kpi .box .value{font-size:20px;font-weight:800}
    @media (max-width:600px){.kpi{grid-template-columns:1fr}}
    footer{margin:24px 0 0;color:var(--muted);font-size:12px}
    .badge-pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f2237;color:#cfe6ff;font-size:12px;border:1px solid #28415f}
    .hero{margin:0 0 12px;border-radius:12px;overflow:hidden;border:1px solid var(--border)}
    .hero img{display:block;width:100%;height:auto;max-height:320px;object-fit:cover}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Calculadora de ULFs</h1>
    <p class="lead">Versão Lite — sem campo de Valor (R$).</p>

    <figure class="hero">
      <img src="./CJC.png" alt="Imagem" />
    </figure>

    <section class="card">
      <div class="grid">
        <div class="col-12">
          <label for="atividade">Atividade</label>
          <select id="atividade">
            <option value="">— Selecione uma atividade —</option>
          </select>
          <div class="small" id="atividadeDescricao" style="margin-top:6px"></div>
        </div>

        <div class="col-6 col-md-6">
          <label for="quantidade">Quantidade</label>
          <input id="quantidade" type="number" inputmode="decimal" step="0.0001" min="0" value="1" placeholder="Ex.: 100" />
          <div class="small inline-help" style="display:flex;justify-content:space-between;gap:12px;margin-top:6px">
            <span>Unidade: <span id="unidadeLabel">—</span></span>
            <span>Coeficiente (<span id="tipoInline">Normal</span>): <span id="coefInline">—</span> ULF por <span id="unidadeInline">—</span></span>
          </div>
          <div class="row" style="align-items:center; gap:8px; margin-top:6px">
            <span class="badge-pill" id="badgeTipo">Tipo: Normal</span>
            <span class="badge-pill" id="badgeCoef">Coef.: —</span>
          </div>
        </div>

        <div class="col-6 col-md-6">
          <label for="codigoSap">Código SAP (digitar)</label>
          <input id="codigoSap" placeholder="Ex.: 651646 ou 653733" />
          <div class="small">Opcional — você pode digitar ou escolher no seletor abaixo.</div>
        </div>

        <div class="col-12">
          <label for="selectSap">Selecionar Código SAP</label>
          <select id="selectSap">
            <option value="">— Selecione um código SAP —</option>
          </select>
          <div class="small" style="margin-top:6px">Ao escolher um código SAP, a atividade e o tipo (Normal/HE) são preenchidos automaticamente.</div>
        </div>

        <div class="col-6">
          <label>Tipo</label>
          <div class="row" role="group" aria-label="Tipo">
            <label class="row" style="align-items:center; gap:6px">
              <input type="radio" name="tipo" id="tipoNormal" value="Normal" checked />
              <span>Normal</span>
            </label>
            <label class="row" style="align-items:center; gap:6px">
              <input type="radio" name="tipo" id="tipoHE" value="HE" />
              <span>HE</span>
            </label>
          </div>
        </div>

        <div class="col-6">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="small">Coef.: <span id="coef">—</span></div>
              <div class="small">Tipo: <span id="tipoLabel">Normal</span></div>
            </div>
            <div class="small">Coef.: <span id="coef2">—</span></div>
          </div>
        </div>

        <div class="col-12 row" style="margin-top:6px">
          <button id="btnAdd" class="btn btn-primary">Adicionar à lista</button>
          <button id="btnLimpar" class="btn btn-danger">Limpar lista</button>
          <button id="btnBaixar" class="btn btn-warning">Baixar lista</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <h2 class="muted" style="margin:0;font-size:16px">Itens</h2>
        <span class="badge-pill"><span id="count">0</span> itens</span>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Atividade</th>
              <th>Código SAP</th>
              <th>Tipo</th>
              <th class="right">Qtd.</th>
              <th>Unid.</th>
              <th class="right">Coef. (ULF/Unid.)</th>
              <th class="right">ULF</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="7" class="right">Total de ULF</td>
              <td class="right"><span id="totalUlf">0,0000</span></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="kpi">
        <div class="box">
          <h3>Total de ULF</h3>
          <div class="value" id="kpiUlf">0,0000</div>
        </div>
        <div class="box">
          <h3>ULF da atividade selecionada</h3>
          <div class="value" id="kpiUlfSel">0,0000</div>
        </div>
      </div>
    </section>

    <footer>
      <a href="./">Voltar para a versão principal</a>
    </footer>
  </div>

  <script>
    // Base de dados — exemplo
    const SAPS = [
      { codigo: '651646', atividade: '01 — Roçada (m²) Densidade 01 (Cerrado)', desc: 'Remoção de vegetação baixa; inclui poda de galhos que invadam a faixa.', unid: 'm²', coefNormal: 0.021, coefHE: 0.021, tipoPadrao: 'Normal' },
      { codigo: '653733', atividade: 'Poda de árvore em rede', desc: 'Poda em rede de distribuição.', unid: 'ud', coefNormal: 0.500, coefHE: 0.500, tipoPadrao: 'Normal' },
      { codigo: '700001', atividade: 'Inspeção de faixa', desc: 'Inspeção de faixa — horas extras.', unid: 'km', coefNormal: 0.120, coefHE: 0.150, tipoPadrao: 'HE' }
    ];

    const state = { itens:[], ulfSel:0, unidSel:'—' };

    // Elements
    const selAtividade = document.getElementById('atividade');
    const atividadeDescEl = document.getElementById('atividadeDescricao');
    const qtdEl = document.getElementById('quantidade');
    const inputSapEl = document.getElementById('codigoSap');
    const selectSapEl = document.getElementById('selectSap');
    const tipoNormalEl = document.getElementById('tipoNormal');
    const tipoHEEl = document.getElementById('tipoHE');
    const tipoLabelEl = document.getElementById('tipoLabel');
    const tipoInlineEl = document.getElementById('tipoInline');
    const coefInlineEl = document.getElementById('coefInline');
    const unidadeLabelEl = document.getElementById('unidadeLabel');
    const unidadeInlineEl = document.getElementById('unidadeInline');
    const coefEl = document.getElementById('coef');
    const coef2El = document.getElementById('coef2');
    const btnAdd = document.getElementById('btnAdd');
    const btnLimpar = document.getElementById('btnLimpar');
    const btnBaixar = document.getElementById('btnBaixar');
    const tbody = document.getElementById('tbody');
    const totalUlfEl = document.getElementById('totalUlf');
    const kpiUlf = document.getElementById('kpiUlf');
    const kpiUlfSel = document.getElementById('kpiUlfSel');
    const countEl = document.getElementById('count');
    const badgeTipo = document.getElementById('badgeTipo');
    const badgeCoef = document.getElementById('badgeCoef');

    function popularSeletores(){
      for(const s of SAPS){
        const optA = document.createElement('option');
        optA.value = s.codigo;
        optA.textContent = s.atividade;
        selAtividade.appendChild(optA);

        const optS = document.createElement('option');
        optS.value = s.codigo;
        optS.textContent = `${s.codigo} — ${s.atividade}`;
        selectSapEl.appendChild(optS);
      }
    }

    function getSapByCodigo(cod){
      return SAPS.find(s => s.codigo === cod) || null;
    }
    function getSapAtual(){
      const cod = selAtividade.value || selectSapEl.value || inputSapEl.value.trim();
      return getSapByCodigo(cod);
    }

    function atualizarCoefETipo(){
      const tipoAtual = tipoHEEl.checked ? 'HE' : 'Normal';
      const sap = getSapAtual();
      const coef = sap ? (tipoAtual === 'HE' ? sap.coefHE : sap.coefNormal) : 0;
      state.ulfSel = coef;
      const unid = sap?.unid || '—';
      state.unidSel = unid;

      coefEl.textContent = fmt(coef);
      coef2El.textContent = fmt(coef);
      coefInlineEl.textContent = fmt(coef);
      tipoLabelEl.textContent = tipoAtual;
      tipoInlineEl.textContent = tipoAtual;
      unidadeLabelEl.textContent = unid;
      unidadeInlineEl.textContent = unid;
      badgeTipo.textContent = 'Tipo: ' + tipoAtual;
      badgeCoef.textContent = 'Coef.: ' + (coef ? coef.toLocaleString('pt-BR',{maximumFractionDigits:4}) : '—');
    }

    selAtividade.addEventListener('change', ()=>{
      const sap = getSapByCodigo(selAtividade.value);
      if(!sap){ resetSelecao(); return; }
      selectSapEl.value = sap.codigo;
      inputSapEl.value = sap.codigo;
      atividadeDescEl.textContent = sap.desc || '';
      if((sap.tipoPadrao||'Normal') === 'HE'){ tipoHEEl.checked = true; } else { tipoNormalEl.checked = true; }
      atualizarCoefETipo();
    });

    selectSapEl.addEventListener('change', ()=>{
      const sap = getSapByCodigo(selectSapEl.value);
      if(!sap){ resetSelecao(); return; }
      selAtividade.value = sap.codigo;
      inputSapEl.value = sap.codigo;
      atividadeDescEl.textContent = sap.desc || '';
      if((sap.tipoPadrao||'Normal') === 'HE'){ tipoHEEl.checked = true; } else { tipoNormalEl.checked = true; }
      atualizarCoefETipo();
    });

    inputSapEl.addEventListener('input', ()=>{
      const sap = getSapByCodigo(inputSapEl.value.trim());
      if(!sap){ resetSelecao(true); return; }
      selAtividade.value = sap.codigo;
      selectSapEl.value = sap.codigo;
      atividadeDescEl.textContent = sap.desc || '';
      if((sap.tipoPadrao||'Normal') === 'HE'){ tipoHEEl.checked = true; } else { tipoNormalEl.checked = true; }
      atualizarCoefETipo();
    });

    function resetSelecao(keepTyped=false){
      if(!keepTyped) inputSapEl.value='';
      selAtividade.value = '';
      selectSapEl.value = '';
      atividadeDescEl.textContent = '';
      state.unidSel = '—';
      unidadeLabelEl.textContent = '—';
      unidadeInlineEl.textContent = '—';
      coefEl.textContent = '—';
      coef2El.textContent = '—';
      coefInlineEl.textContent = '—';
      badgeCoef.textContent = 'Coef.: —';
      state.ulfSel = 0;
      kpiUlfSel.textContent = '0,0000';
      tipoNormalEl.checked = true;
      tipoLabelEl.textContent = 'Normal';
      tipoInlineEl.textContent = 'Normal';
      badgeTipo.textContent = 'Tipo: Normal';
    }

    tipoNormalEl.addEventListener('change', atualizarCoefETipo);
    tipoHEEl.addEventListener('change', atualizarCoefETipo);

    document.getElementById('btnAdd').addEventListener('click', ()=>{
      const sap = getSapAtual();
      const atividade = sap ? sap.atividade : (selAtividade.options[selAtividade.selectedIndex]?.textContent || '—');
      const cod = sap ? sap.codigo : (inputSapEl.value.trim() || selectSapEl.value || '—');
      const tipo = document.querySelector('input[name="tipo"]:checked')?.value || 'Normal';
      const qtd = parseFloat(qtdEl.value || '0') || 0;
      const coef = state.ulfSel || 0;
      const unid = state.unidSel || (sap?.unid || '—');
      const ulf = qtd * (coef || 0);

      const item = { id: crypto.randomUUID(), atividade, codigo: cod, tipo, qtd, unid, coef, ulf };
      state.itens.push(item);
      render();
    });

    document.getElementById('btnLimpar').addEventListener('click', ()=>{
      if(state.itens.length === 0) return;
      if(confirm('Tem certeza que deseja limpar a lista?')){
        state.itens = [];
        render();
      }
    });

    document.getElementById('btnBaixar').addEventListener('click', ()=>{
      const linhas = [];
      linhas.push(['#','Atividade','Código SAP','Tipo','Qtd.','Unid.','Coef. (ULF/Unid.)','ULF'].join(';'));
      state.itens.forEach((it, i)=>{
        linhas.push([
          String(i+1),
          csv(it.atividade),
          csv(it.codigo),
          it.tipo,
          String(it.qtd).replace('.',','),
          it.unid,
          String(it.coef).replace('.',','),
          String(round4(it.ulf)).replace('.',',')
        ].join(';'));
      });
      const csvStr = '\uFEFF' + linhas.join('\n');
      const blob = new Blob([csvStr], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'lista-ulf-lite.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    function render(){
      tbody.innerHTML = '';
      let total = 0;
      state.itens.forEach((it, i)=>{
        total += it.ulf;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${esc(it.atividade)}</td>
          <td>${esc(it.codigo)}</td>
          <td>${esc(it.tipo)}</td>
          <td class="right">${fmt(it.qtd)}</td>
          <td>${esc(it.unid)}</td>
          <td class="right">${fmt(it.coef)}</td>
          <td class="right">${fmt4(it.ulf)}</td>
        `;
        tbody.appendChild(tr);
      });
      totalUlfEl.textContent = fmt4(total);
      kpiUlf.textContent = fmt4(total);
      kpiUlfSel.textContent = fmt4(state.ulfSel || 0);
      countEl.textContent = String(state.itens.length);
    }

    // Utils
    function fmt(n){ return Number(n||0).toLocaleString('pt-BR', {maximumFractionDigits: 4}); }
    function fmt4(n){
      return Number(round4(n)).toLocaleString('pt-BR', {minimumFractionDigits: 4, maximumFractionDigits: 4});
    }
    function round4(n){ return Math.round((Number(n)||0) * 10000) / 10000; }
    function esc(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c])); }
    function csv(s){ const v = (s ?? '').toString(); return /[;"\n]/.test(v) ? '"' + v.replace(/"/g,'""') + '"' : v; }

    // Init
    (function init(){
      popularSeletores();
      resetSelecao();
      render();
    })();
  </script>
</body>
</html>
