<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MeuApp — Calculadora de ULFs</title>

<!-- PWA -->
<meta name="theme-color" content="#0d6efd" />
<link rel="manifest" href="manifest.webmanifest" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' rx='56' fill='%230d6efd'/%3E%3Ctext x='50%25' y='57%25' text-anchor='middle' font-family='Arial,Helvetica,sans-serif' font-size='140' fill='white'%3EM%3C/text%3E%3C/svg%3E" />

<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --acc:#22c55e; --txt:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;
    background:linear-gradient(160deg,#0b1223,#0a0f1a 50%,#0b1223);
    color:var(--txt);
  }
  header{padding:20px 16px; text-align:center}
  header h1{margin:0; font-size:clamp(20px,4vw,28px)}
  header p{margin:6px 0 0; color:var(--muted); font-size:14px}
  .wrap{max-width:980px; margin:0 auto; padding:16px}
  .card{
    background:rgba(17,24,39,0.75); border:1px solid rgba(148,163,184,0.15);
    border-radius:14px; padding:16px; backdrop-filter: blur(6px);
  }
  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:720px){ .grid{grid-template-columns:1fr} }
  label{font-size:13px; color:var(--muted); display:block; margin-bottom:6px}
  input, select, textarea{
    width:100%; padding:12px 12px; border-radius:10px;
    border:1px solid rgba(148,163,184,0.25); background:#0b1223; color:var(--txt);
    outline:none; transition: border .2s;
  }
  input:focus, select:focus, textarea:focus{border-color:#60a5fa}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media (max-width:520px){ .row{grid-template-columns:1fr} }
  .muted{color:var(--muted); font-size:12px}
  .result{
    margin-top:14px; display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;
  }
  @media (max-width:640px){ .result{grid-template-columns:1fr} }
  .pill{
    background:#0b1223; border:1px solid rgba(148,163,184,0.25); border-radius:12px;
    padding:14px
  }
  .pill h3{margin:0 0 6px; font-size:14px; color:var(--muted)}
  .pill p{margin:0; font-size:18px}
  .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
  button{
    padding:10px 14px; border-radius:10px; border:1px solid rgba(148,163,184,0.25);
    background:#0b1223; color:var(--txt); cursor:pointer
  }
  button.primary{background:linear-gradient(180deg,#16a34a,#059669); border:none}
  .table{
    margin-top:18px; overflow:auto; border-radius:12px; border:1px solid rgba(148,163,184,0.2)
  }
  table{width:100%; border-collapse:separate; border-spacing:0}
  th, td{padding:10px 12px; border-bottom:1px solid rgba(148,163,184,0.15); text-align:left; font-size:13px}
  th{background:#0b1223; color:#cbd5e1; position:sticky; top:0}
  tr:last-child td{border-bottom:none}
  .right{text-align:right}
  .inline{display:flex; gap:10px; align-items:center}
  .inline > *{flex:1}
  .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#0b1223; border:1px solid rgba(148,163,184,0.3); font-size:12px; color:#cbd5e1}

  /* PWA UI: botão instalar e dica */
  .topbar {
    max-width:980px; margin:0 auto; padding:0 16px 8px; display:flex; justify-content:flex-end;
  }
  .btn-install { background:#0d6efd; border:none; color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; display:none }
  .install-hint{
    display:none; max-width:980px; margin:0 auto; padding:8px 12px; color:#084298;
    background:#e7f1ff; border:1px dashed #cfe2ff; border-radius:10px;
  }
  .install-hint.show{display:block}
</style>
</head>
<body>
  <div class="topbar">
    <button id="btnInstall" class="btn-install">Instalar</button>
  </div>
  <div id="installHint" class="install-hint">Para instalar: no Android toque ⋮ → Instalar. No iPhone: Compartilhar → Adicionar à Tela de Início.</div>

  <header>
    <h1>Calculadora de ULFs</h1>
    <p>1 ULF = R$ 13,53 • Coeficientes conforme o contrato “Contrato - 4600012975-34-37.pdf”.</p>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="grid">
        <div>
          <label for="atividade">Atividade</label>
          <select id="atividade"></select>
          <div id="desc" class="muted" style="margin-top:6px"></div>
        </div>
        <div class="row">
          <div>
            <label for="quantidade">Quantidade</label>
            <input id="quantidade" type="number" min="0" step="0.01" placeholder="Ex.: 100" />
            <div id="unidade" class="muted" style="margin-top:6px"></div>
          </div>
          <div>
            <label for="sap">Código SAP (digitar)</label>
            <input id="sap" type="text" inputmode="numeric" placeholder="Ex.: 651546 ou 653733" />
            <div class="muted">Opcional — você pode digitar ou escolher no seletor abaixo.</div>
          </div>
        </div>

        <div>
          <label for="sapSelect">Selecionar Código SAP</label>
          <select id="sapSelect">
            <option value="">— Selecione um código SAP —</option>
          </select>
          <div class="muted" style="margin-top:6px">Ao escolher um código SAP, a atividade e o tipo (Normal/HE) são preenchidos automaticamente.</div>
        </div>

        <div class="inline" style="display:none">
          <div>
            <label for="tipo">Tipo</label>
            <select id="tipo">
              <option value="Normal">Normal</option>
              <option value="HE">HE</option>
            </select>
          </div>
          <div>
            <span class="badge" id="coefBadge">Coef.: —</span>
          </div>
        </div>
        <div>
          <span class="badge" id="tipoBadgeVisivel">Tipo: Normal</span>
          <span class="badge" id="coefBadgeVisivel" style="margin-left:8px">Coef.: —</span>
        </div>
      </div>

      <div class="actions">
        <button class="primary" id="adicionar">Adicionar à lista</button>
        <button id="limpar">Limpar lista</button>
      </div>

      <div class="result">
        <div class="pill">
          <h3>Total de ULF</h3>
          <p id="totalUlf">0,0000</p>
        </div>
        <div class="pill">
          <h3>Valor (R$)</h3>
          <p id="totalValor">R$ 0,00</p>
        </div>
        <div class="pill">
          <h3>ULF da atividade selecionada</h3>
          <p id="ulfAtual">0,0000</p>
        </div>
      </div>

      <div class="table" id="tabelaWrap" style="display:none">
        <table id="tabela">
          <thead>
            <tr>
              <th>#</th>
              <th>Atividade</th>
              <th>Código SAP</th>
              <th>Tipo</th>
              <th class="right">Qtd.</th>
              <th>Unid.</th>
              <th class="right">Coef. (ULF/Unid.)</th>
              <th class="right">ULF</th>
              <th class="right">R$</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

    </div>
  </div>

<script>
// ===== Seu app (inalterado, apenas encapsulado) =====
(function(){
  const ULF_VALUE = 13.53; // R$

  const atividades = [
    {id:1, nome:"Roçada (m²) Densidade 01 (Cerrado)", unit:"m²", desc:"Remoção de vegetação baixa; inclui poda de galhos que invadam a faixa."},
    {id:2, nome:"Roçada (m²) Densidade 02 (Vegetação Adensada)", unit:"m²", desc:"Vegetação até 10 cm de diâmetro; pode exigir foice/facão/motorroçadeira."},
    {id:3, nome:"Roçada (m²) Densidade 03 (Desmatamento)", unit:"m²", desc:"Necessário machado/motosserra; pode haver troncos até 40 cm e >15 árvores/100 m."},
    {id:4, nome:"Corte de taquaral (m²) Pequeno (Rural)", unit:"m²", desc:"Taquaras/taquaris <3 cm; sem motosserra; limpeza ao nível do solo."},
    {id:5, nome:"Corte de bambuzal (m²) Pequeno (Rural)", unit:"m²", desc:"Bambu <8 cm; sem motosserra; limpeza ao nível do solo."},
    {id:6, nome:"Corte de bambuzal (m²) Grande (Rural)", unit:"m²", desc:"Bambu ≥8 cm; com motosserra/foice; limpeza ao nível do solo."},
    {id:7, nome:"Corte de bambuzal (m²) Urbano", unit:"m²", desc:"Corte em área urbana; inclui recolhimento do entulho."},
    {id:8, nome:"Poda de bambuzal (m²) Pequeno (Rural)", unit:"m²", desc:"Bambu <8 cm; poda até 2 m de altura; sem motosserra."},
    {id:9, nome:"Poda de bambuzal (m²) Grande (Rural)", unit:"m²", desc:"Bambu ≥8 cm; poda até 2 m de altura; com motosserra/foice."},
    {id:10, nome:"Poda de bambuzal (m²) Urbano", unit:"m²", desc:"Poda até 2 m; área urbana; inclui recolhimento."},
    {id:11, nome:"Corte de árvore isolada (un) Rural — sem direcionamento/recolhimento", unit:"un", desc:"Árvore isolada; sem direcionamento; sem recolhimento."},
    {id:12, nome:"Corte de árvore 40–60 cm ou com direcionamento (un) Rural", unit:"un", desc:"Com direcionamento; sem recolhimento."},
    {id:13, nome:"Corte de árvore diâmetro >60 cm (un) Rural", unit:"un", desc:"Com direcionamento; sem recolhimento; inclui ordenamento de resíduos."},
    {id:14, nome:"Corte de árvore pequeno porte (un) Urbano — com recolhimento", unit:"un", desc:"Sem direcionamento; com recolhimento."},
    {id:15, nome:"Corte de árvore (un) Urbano — com direcionamento e recolhimento", unit:"un", desc:"Com direcionamento; inclui desbaste, corte de toras e recolhimento."},
    {id:16, nome:"Abate de reflorestamento em crescimento — preventivo (un) Rural", unit:"un", desc:"Supressão preventiva de exóticas em crescimento."},
    {id:17, nome:"Poda de árvore (un) — sem recolhimento (Rural/Urbano)", unit:"un", desc:"Sem recolhimento."},
    {id:18, nome:"Poda de árvore (un) — com recolhimento (Rural/Urbano)", unit:"un", desc:"Com recolhimento."},
    {id:19, nome:"Poda/supressão parcial (un) — com recolhimento (Rural/Urbano)", unit:"un", desc:"Grande volume; com recolhimento."},
    {id:20, nome:"Aceiro (un)", unit:"un", desc:"Desbaste ao redor do poste: 1 m capinado + 3 m roçado; descartar fora da área."},
    {id:21, nome:"Limpeza de pátio de Subestação (m²)", unit:"m²", desc:"Limpeza de pátio/instalações; inclui recolhimento e destinação final."}
  ];

  const coeficientes = {
    1:{Normal:0.021, HE:0.029},
    2:{Normal:0.030, HE:0.042},
    3:{Normal:0.039, HE:0.054},
    4:{Normal:0.200, HE:0.280},
    5:{Normal:0.700, HE:0.980},
    6:{Normal:1.500, HE:2.100},
    7:{Normal:2.000, HE:2.800},
    8:{Normal:0.350, HE:0.420},
    9:{Normal:0.750, HE:1.050},
    10:{Normal:1.000, HE:1.400},
    11:{Normal:0.330, HE:0.462},
    12:{Normal:0.500, HE:0.700},
    13:{Normal:3.000, HE:4.200},
    14:{Normal:1.250, HE:1.750},
    15:{Normal:3.500, HE:4.900},
    16:{Normal:0.009, HE:0.012},
    17:{Normal:0.500, HE:0.700},
    18:{Normal:1.000, HE:1.400},
    19:{Normal:3.000, HE:4.200},
    20:{Normal:5.750, HE:8.050},
    21:{Normal:0.022, HE:0.030}
  };

  const sapMap = [
    {sap:"651546", atividadeId:1, tipo:"Normal"},
    {sap:"653733", atividadeId:1, tipo:"HE"},
    {sap:"651547", atividadeId:2, tipo:"Normal"},
    {sap:"653734", atividadeId:2, tipo:"HE"},
    {sap:"651548", atividadeId:3, tipo:"Normal"},
    {sap:"653735", atividadeId:3, tipo:"HE"},
    {sap:"654053", atividadeId:4, tipo:"Normal"},
    {sap:"651549", atividadeId:5, tipo:"Normal"},
    {sap:"653736", atividadeId:5, tipo:"HE"},
    {sap:"651550", atividadeId:6, tipo:"Normal"},
    {sap:"653737", atividadeId:6, tipo:"HE"},
    {sap:"651551", atividadeId:7, tipo:"Normal"},
    {sap:"653738", atividadeId:7, tipo:"HE"},
    {sap:"653729", atividadeId:8, tipo:"Normal"},
    {sap:"653750", atividadeId:8, tipo:"HE"},
    {sap:"653730", atividadeId:9, tipo:"Normal"},
    {sap:"653751", atividadeId:9, tipo:"HE"},
    {sap:"653731", atividadeId:10, tipo:"Normal"},
    {sap:"653752", atividadeId:10, tipo:"HE"},
    {sap:"651552", atividadeId:11, tipo:"Normal"},
    {sap:"653739", atividadeId:11, tipo:"HE"},
    {sap:"651553", atividadeId:12, tipo:"Normal"},
    {sap:"653740", atividadeId:12, tipo:"HE"},
    {sap:"651554", atividadeId:13, tipo:"Normal"},
    {sap:"653741", atividadeId:13, tipo:"HE"},
    {sap:"651555", atividadeId:14, tipo:"Normal"},
    {sap:"653742", atividadeId:14, tipo:"HE"},
    {sap:"651556", atividadeId:15, tipo:"Normal"},
    {sap:"653743", atividadeId:15, tipo:"HE"},
    {sap:"651557", atividadeId:16, tipo:"Normal"},
    {sap:"653744", atividadeId:16, tipo:"HE"},
    {sap:"651558", atividadeId:17, tipo:"Normal"},
    {sap:"653745", atividadeId:17, tipo:"HE"},
    {sap:"651559", atividadeId:18, tipo:"Normal"},
    {sap:"653746", atividadeId:18, tipo:"HE"},
    {sap:"651560", atividadeId:19, tipo:"Normal"},
    {sap:"653747", atividadeId:19, tipo:"HE"},
    {sap:"618333", atividadeId:20, tipo:"Normal"},
    {sap:"653732", atividadeId:20, tipo:"HE"},
    {sap:"652105", atividadeId:21, tipo:"Normal"},
    {sap:"653748", atividadeId:21, tipo:"HE"},
  ];

  // Preenche selects
  const selAtv = document.getElementById('atividade');
  atividades.forEach((a)=>{
    const opt = document.createElement('option');
    opt.value = a.id;
    opt.textContent = `${String(a.id).padStart(2,'0')} — ${a.nome}`;
    selAtv.appendChild(opt);
  });

  const selSAP = document.getElementById('sapSelect');
  sapMap.forEach(entry=>{
    const atv = atividades.find(a=>a.id===entry.atividadeId);
    if (!atv) return;
    const opt = document.createElement('option');
    opt.value = entry.sap;
    opt.textContent = `${entry.sap} — ${String(atv.id).padStart(2,'0')} ${atv.nome} (${entry.tipo})`;
    selSAP.appendChild(opt);
  });

  const qtdEl = document.getElementById('quantidade');
  const sapEl = document.getElementById('sap');
  const ulfAtualEl = document.getElementById('ulfAtual');
  const unidadeEl = document.getElementById('unidade');
  const descEl = document.getElementById('desc');
  const totalUlfEl = document.getElementById('totalUlf');
  const totalValorEl = document.getElementById('totalValor');

  let tipoAtual = 'Normal';
  const tipoBadgeVisivel = document.getElementById('tipoBadgeVisivel');
  const coefBadgeVisivel = document.getElementById('coefBadgeVisivel');

  function fmtNumber(n, dec=4){
    return (isFinite(n)?n:0).toLocaleString('pt-BR',{minimumFractionDigits:dec, maximumFractionDigits:dec});
  }
  function fmtMoney(n){
    return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  }

  function getCoef(atvId, tipo){
    const c = coeficientes[atvId] || {Normal:0, HE:0};
    return (tipo === 'HE') ? c.HE : c.Normal;
  }

  function setTipo(newTipo){
    tipoAtual = newTipo === 'HE' ? 'HE' : 'Normal';
    tipoBadgeVisivel.textContent = `Tipo: ${tipoAtual}`;
  }

  function refreshInfo(){
    const atvId = +selAtv.value;
    const a = atividades.find(x=>x.id===atvId);
    if (!a) return;
    const coef = getCoef(atvId, tipoAtual);
    unidadeEl.textContent = `Unidade: ${a.unit} • Coeficiente (${tipoAtual}): ${coef.toLocaleString('pt-BR',{minimumFractionDigits:3,maximumFractionDigits:4})} ULF por ${a.unit}`;
    descEl.textContent = a.desc || '';
    coefBadgeVisivel.textContent = `Coef.: ${coef.toLocaleString('pt-BR',{minimumFractionDigits:3,maximumFractionDigits:4})}`;
    const qtd = parseFloat(qtdEl.value)||0;
    ulfAtualEl.textContent = fmtNumber(qtd * coef);
  }

  selAtv.addEventListener('change', refreshInfo);
  qtdEl.addEventListener('input', refreshInfo);

  selSAP.addEventListener('change', ()=>{
    const code = selSAP.value;
    if (!code){
      setTipo('Normal');
      refreshInfo();
      return;
    }
    const map = sapMap.find(s=>s.sap===code);
    if (map){
      selAtv.value = String(map.atividadeId);
      setTipo(map.tipo);
      sapEl.value = code;
      refreshInfo();
    }
  });

  sapEl.addEventListener('input', ()=>{
    const code = sapEl.value.trim();
    const map = sapMap.find(s=>s.sap===code);
    if (map){
      selAtv.value = String(map.atividadeId);
      setTipo(map.tipo);
      selSAP.value = code;
    } else {
      selSAP.value = "";
      setTipo('Normal');
    }
    refreshInfo();
  });

  setTipo('Normal');
  refreshInfo();

  const itens = [];
  const tbody = document.querySelector('#tabela tbody');
  const tabelaWrap = document.getElementById('tabelaWrap');

  function render(){
    tbody.innerHTML = '';
    let totalUlf = 0;
    itens.forEach((it,idx)=>{
      totalUlf += it.ulf;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${it.nome}</td>
        <td>${it.sap||''}</td>
        <td>${it.tipo}</td>
        <td class="right">${fmtNumber(it.qtd,2)}</td>
        <td>${it.unit}</td>
        <td class="right">${fmtNumber(it.coef,4)}</td>
        <td class="right">${fmtNumber(it.ulf,4)}</td>
        <td class="right">${fmtMoney(it.valor)}</td>
        <td class="right"><button data-i="${idx}" class="rem">Remover</button></td>
      `;
      tbody.appendChild(tr);
    });
    document.querySelectorAll('.rem').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const i = +e.currentTarget.getAttribute('data-i');
        itens.splice(i,1);
        render();
      });
    });
    tabelaWrap.style.display = itens.length? 'block':'none';
    totalUlfEl.textContent = fmtNumber(totalUlf,4);
    totalValorEl.textContent = fmtMoney(totalUlf * ULF_VALUE);
  }

  document.getElementById('adicionar').addEventListener('click', ()=>{
    const atvId = +selAtv.value;
    const a = atividades.find(x=>x.id===atvId);
    const qtd = parseFloat(qtdEl.value);
    if (!qtd || qtd<=0){ alert('Informe uma quantidade válida.'); return; }
    const coef = getCoef(atvId, tipoAtual);
    const ulf = qtd * coef;
    const sapCode = sapEl.value.trim() || selSAP.value || '';
    itens.push({
      id:a.id, nome:a.nome, unit:a.unit, tipo: tipoAtual, coef, qtd,
      ulf, valor: ulf * ULF_VALUE, sap: sapCode
    });
    render();
    qtdEl.value = '';
    ulfAtualEl.textContent = '0,0000';
    qtdEl.focus();
  });

  document.getElementById('limpar').addEventListener('click', ()=>{
    if (confirm('Deseja limpar todas as linhas?')){
      itens.splice(0,itens.length);
      render();
    }
  });

})();
</script>

<script>
// ===== PWA: botão instalar + registro do Service Worker =====
let deferredPrompt;
const btnInstall = document.getElementById('btnInstall');

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  btnInstall.style.display = 'inline-block';
  document.getElementById('installHint').classList.remove('show');
});

btnInstall?.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  btnInstall.style.display = 'none';
});

setTimeout(()=> {
  if (!window.matchMedia('(display-mode: standalone)').matches) {
    document.getElementById('installHint').classList.add('show');
  }
}, 1500);

// Registrar SW
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('SW registrado:', reg.scope))
      .catch(err => console.error('Erro SW:', err));
  });
}
</script>
</body>
</html>
